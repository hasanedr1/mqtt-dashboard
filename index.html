<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPS OUTPUT</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#0f1724;
      --card:#0b1220;
      --muted:#9aa4b2;
      --accent:#5eead4;
      --error:#f87171;
      --glass:rgba(255,255,255,0.03);
    }

    * {
      box-sizing:border-box;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    }

    body {
      margin:0;
      background:linear-gradient(180deg,#071021 0%,#071827 100%);
      color:#e6eef6;
      min-height:100vh;
      padding:28px;
    }

    .shell {
      max-width:1000px;
      margin:0 auto;
    }

    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
    }

    h1 {
      font-size:20px;
      margin:0;
    }

    p.lead {
      margin:0;
      color:var(--muted);
      font-size:13px;
    }

    .controls {
      display:flex;
      gap:8px;
      align-items:center;
    }

    .btn {
      background:var(--glass);
      border:1px solid rgba(255,255,255,0.03);
      padding:8px 12px;
      border-radius:10px;
      color:var(--accent);
      cursor:pointer;
    }

    .btn:active {
      transform:translateY(1px);
    }

    .grid {
      display:grid;
      grid-template-columns:1fr 420px;
      gap:16px;
    }

    .card {
      background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
      border-radius:12px;
      padding:14px;
      border:1px solid rgba(255,255,255,0.03);
      margin-bottom:12px;
    }

    .card h2 {
      margin:0 0 8px 0;
      font-size:14px;
    }

    .list {
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:8px;
    }

    .item {
      background:rgba(255,255,255,0.02);
      padding:8px;
      border-radius:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .item .k {
      color:var(--muted);
      font-size:13px;
    }

    .item .v {
      font-weight:600;
    }

    .error {
      color:var(--error);
    }

    @media (max-width:900px) {
      .grid {
        grid-template-columns:1fr;
      }
      .list {
        grid-template-columns:1fr;
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div>
        <h1>TEST OUTPUT</h1>
        <p class="lead">Shows latest Tests Results </p>
      </div>
      <div class="controls">
        <button id="refreshBtn" class="btn">Refresh now</button>
        <div id="status" style="color:var(--muted);font-size:13px">Idle</div>
      </div>
    </header>

    <div class="grid">
      <div>
        <!-- MQTT BLOCK -->
        <div class="card" id="mqttCard">
          <h2>SPS Values</h2>
          <div id="time" style="color:var(--muted);font-size:13px;margin-bottom:8px">—</div>
          <div class="list" id="mqttList"></div>
        </div>

        <!-- CAN BLOCK -->
        <div class="card" id="canCard">
          <h2>CAN Values</h2>
          <div class="list" id="canList"></div>
        </div>
      </div>

      <div>
        <div class="card">
          <!-- Platz für zukünftige Charts -->
        </div>
      </div>
    </div>
  </div>

  <script>
    const GIST_RAW_URL = 'https://gist.githubusercontent.com/hasanedr1/4003001b4b70a1fce5249a071c172358/raw/data.json';
    const POLL_INTERVAL = 10000;

    const statusEl = document.getElementById('status');
    const refreshBtn = document.getElementById('refreshBtn');
    const mqttList = document.getElementById('mqttList');
    const canList = document.getElementById('canList');
    const timeEl = document.getElementById('time');

    async function fetchAndRender() {
      statusEl.textContent = 'Fetching...';
      try {
        const res = await fetch(GIST_RAW_URL + '?_=' + Date.now());
        if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
        const json = await res.json();
        render(json);
        statusEl.textContent = 'Last updated: ' + new Date().toLocaleTimeString();
      } catch (err) {
        statusEl.textContent = 'Error: ' + err.message;
        console.error(err);
      }
    }

    function render(json) {
      timeEl.textContent = json.time || 'no timestamp';
      const values = json.values || json || {};

      mqttList.innerHTML = '';
      canList.innerHTML = '';

      // MQTT Werte anzeigen
      if (values.mqtt && typeof values.mqtt === 'object') {
        for (const k of Object.keys(values.mqtt)) {
          const v = values.mqtt[k];
          const isError = k.toUpperCase().includes('ERROR') || k.toUpperCase().includes('ERR');
          const item = document.createElement('div');
          item.className = 'item';
          item.innerHTML = `
            <div class="k">${escapeHtml(k)}</div>
            <div class="v ${isError ? 'error' : ''}">${escapeHtml(JSON.stringify(v))}</div>
          `;
          mqttList.appendChild(item);
        }
      }

      // CAN Werte anzeigen
      if (values.can && typeof values.can === 'object') {
        for (const k of Object.keys(values.can)) {
          const v = values.can[k];
          const isError = k.toUpperCase().includes('ERROR') || k.toUpperCase().includes('ERR');
          const item = document.createElement('div');
          item.className = 'item';
          item.innerHTML = `
            <div class="k">${escapeHtml(k)}</div>
            <div class="v ${isError ? 'error' : ''}">${escapeHtml(JSON.stringify(v))}</div>
          `;
          canList.appendChild(item);
        }
      }
    }

    function escapeHtml(s) {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function startPolling() {
      fetchAndRender();
      setInterval(fetchAndRender, POLL_INTERVAL);
    }

    refreshBtn.addEventListener('click', fetchAndRender);
    startPolling();
  </script>
</body>
</html>
